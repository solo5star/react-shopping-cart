import{j as q,a as m,d as P,e as E,f as g,g as h}from"./http-b339b6dc.js";const T=[200,201,202,203,204,205,206,207,208,226,300,301,302,303,304,307,308];class U{constructor(t){this.responsePromise=t()}assertStatusCode(t,e){return(Array.isArray(e)?e:[e]).includes(t.statusCode)}async accept(t){const e=await this.responsePromise;return this.assertStatusCode(e,t)?e:null}async acceptOrThrow(t){const e=await this.responsePromise;if(!this.assertStatusCode(e,t))throw new Error(`Server responses with status code ${e.statusCode}`);return e}async acceptOkOrThrow(){return this.acceptOrThrow(T)}}class _{constructor(t,...e){this.internalQueryParams=null,this.path=t,this.internalParams=e}queryParams(t){return this.internalQueryParams=t,this}toString(){const t=[...this.internalParams],e=this.path.split("/").map(a=>a.startsWith(":")?t.shift():a).join("/"),r=Object.keys(this.internalQueryParams??{}).length===0?"":`?${new URLSearchParams(this.internalQueryParams??{}).toString()}`;return e+r}}class b{constructor(t={}){this.options=t}getUrl(t){return q(this.options.baseUrl??"",t)}async parseResponseData(t){try{return await t.json()}catch{return null}}fetch(t,e,r){return new U(async()=>{const a=await fetch(this.getUrl(e.toString()),{method:t,...r});return{statusCode:a.status,data:await this.parseResponseData(a),headers:Object.fromEntries(a.headers.entries())}})}get(t){return this.fetch("GET",t)}post(t,e){return this.fetch("POST",t,{headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}patch(t,e){return this.fetch("PATCH",t,{headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}delete(t){return this.fetch("DELETE",t)}path(t,...e){return new _(t,...e)}}const l=new b({baseUrl:"/react-shopping-cart/storybook"}),S=l.path.bind(l),R=s=>({setSelf:t,onSet:e})=>{const r=localStorage.getItem(s);r!==null&&t(JSON.parse(r)),e((a,p,o)=>{if(o){localStorage.removeItem(s);return}localStorage.setItem(s,JSON.stringify(a))})},w=m({key:"cartItemEntitiesQuery",get:()=>l.get("/cart-items").acceptOrThrow(200).then(s=>s.data)}),y=P({key:"syncCartItemState",default:E({key:"syncCartItemState/default",get:s=>({get:t})=>{const e=t(w);return{semaphore:null,state:{productId:s,...e.find(r=>r.product.id===s)},enqueuedUpdates:[]}}}),effects:[({setSelf:s,onSet:t})=>{const e=r=>{const a=c=>{const u=l.delete(S("/cart-items/:cartItemId",c)).acceptOrThrow(204);return u.finally(()=>s(i=>i instanceof h?i:e({...i,semaphore:null}))),{...r,state:{productId:r.state.productId},semaphore:u,enqueuedUpdates:[]}},p=()=>{const c=l.post("/cart-items",{productId:r.state.productId}).acceptOrThrow(201);return c.then(u=>s(i=>{var d;return i instanceof h?i:e({...i,state:{...i.state,id:Number((d=String(u.headers.location).match(/(\d+)$/))==null?void 0:d.at(0))},semaphore:null})})),{...r,semaphore:c}},o=(c,u)=>{const i=l.patch(S("/cart-items/:cartItemId",c),{quantity:u}).acceptOrThrow(200);return i.finally(()=>s(d=>d instanceof h?d:e({...d,semaphore:null}))),{...r,semaphore:i,state:{...r.state,quantity:u},enqueuedUpdates:[]}};if(r.semaphore!==null)return r;const n=r.enqueuedUpdates.reduce((c,u)=>({...c,...u}),r.state);return"quantity"in n&&n.quantity<=0?"id"in n?a(n.id):r:"quantity"in n?"id"in n?"quantity"in r.state&&r.state.quantity===n.quantity?r:o(n.id,n.quantity):p():r};t(r=>{const a=e(r);a&&s(a)})}]}),f=g({key:"localCartItemsState",default:m({key:"localCartItemsState/default",get:({get:s})=>s(w)})}),O=g({key:"unselectedForOrdersState",default:[],effects:[R("unselectedForOrders")]}),x=m({key:"cartItemsState",get:({get:s})=>{const t=s(f),e=s(O);return t.map(r=>({...r,unselectedForOrder:e.includes(r.product.id)}))},set:({get:s,set:t},e)=>{const r=s(f);if(e instanceof h)throw new Error("reset of cartItemsState is not implemented!");const a=e.filter(o=>o.quantity>0);t(f,a),t(O,a.filter(o=>o.unselectedForOrder).map(o=>o.product.id)),r.filter(o=>a.find(n=>n.product.id===o.product.id)===void 0).forEach(o=>{t(y(o.product.id),n=>({...n,enqueuedUpdates:[...n.enqueuedUpdates,{quantity:0}]}))}),a.forEach(o=>{t(y(o.product.id),n=>({...n,enqueuedUpdates:[...n.enqueuedUpdates,{quantity:o.quantity}]}))})}});export{x as c};
//# sourceMappingURL=cartItemsState-2aec6f64.js.map
